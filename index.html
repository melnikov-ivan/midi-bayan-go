<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XIAO-BLE Web Bluetooth</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 500px;
            width: 100%;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .status {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
            text-align: center;
        }

        .status.disconnected {
            background: #fee;
            color: #c33;
        }

        .status.connected {
            background: #efe;
            color: #3c3;
        }

        .status.scanning {
            background: #eef;
            color: #33c;
        }

        button {
            width: 100%;
            padding: 14px;
            margin-bottom: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .value-display {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            min-height: 50px;
            word-break: break-all;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #333;
        }

        .value-display.empty {
            color: #999;
            font-style: italic;
        }

        .info {
            background: #e7f3ff;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 12px;
            color: #0066cc;
        }

        .error {
            background: #fee;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #c33;
            display: none;
        }

        .error.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîµ XIAO-BLE Control</h1>
        <p class="subtitle">Web Bluetooth –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º</p>

        <div id="status" class="status disconnected">–û—Ç–∫–ª—é—á–µ–Ω–æ</div>
        <div id="error" class="error"></div>

        <div class="info">
            <strong>Service UUID:</strong> 12345678-1234-5678-1234-567890abcdef<br>
            <strong>Characteristic UUID:</strong> fedcba09-8765-4321-8765-432110325476
        </div>

        <button id="connectBtn" class="btn-primary" onclick="connect()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
        <button id="disconnectBtn" class="btn-danger" onclick="disconnect()" disabled>–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>

        <div class="input-group">
            <label>–ü—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:</label>
            <div id="readValue" class="value-display empty">–ó–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ</div>
            <button id="readBtn" class="btn-success" onclick="readCharacteristic()" disabled>–ü—Ä–æ—á–∏—Ç–∞—Ç—å</button>
        </div>

        <div class="input-group">
            <label>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ:</label>
            <input type="text" id="writeValue" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏" />
            <button id="writeBtn" class="btn-secondary" onclick="writeCharacteristic()" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <script>
        const SERVICE_UUID = '12345678-1234-5678-1234-567890abcdef';
        const CHARACTERISTIC_UUID = 'fedcba09-8765-4321-8765-432110325476';

        let device = null;
        let server = null;
        let service = null;
        let characteristic = null;

        function updateStatus(text, className) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = text;
            statusEl.className = `status ${className}`;
        }

        function showError(message) {
            const errorEl = document.getElementById('error');
            errorEl.textContent = message;
            errorEl.classList.add('show');
            setTimeout(() => {
                errorEl.classList.remove('show');
            }, 5000);
        }

        function updateButtons(connected) {
            document.getElementById('connectBtn').disabled = connected;
            document.getElementById('disconnectBtn').disabled = !connected;
            document.getElementById('readBtn').disabled = !connected;
            document.getElementById('writeBtn').disabled = !connected;
        }

        async function connect() {
            try {
                updateStatus('–ü–æ–∏—Å–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞...', 'scanning');
                showError('');

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ Web Bluetooth
                if (!navigator.bluetooth) {
                    throw new Error('Web Bluetooth –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome/Edge –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ –∏–ª–∏ Android.');
                }

                // –ü–æ–∏—Å–∫ –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É
                device = await navigator.bluetooth.requestDevice({
                    // filters: [{
                        // services: [SERVICE_UUID]
                        //name: 'Midi-Bayan'
                    // }],
                    acceptAllDevices: true,
                    optionalServices: [SERVICE_UUID]
                });

                updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...', 'scanning');

                device.addEventListener('gattserverdisconnected', onDisconnected);

                server = await device.gatt.connect();
                updateStatus('–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞...', 'scanning');

                service = await server.getPrimaryService(SERVICE_UUID);
                updateStatus('–ü–æ–ª—É—á–µ–Ω–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏...', 'scanning');

                characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);

                updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ', 'connected');
                updateButtons(true);

                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–∏—Ç–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
                await readCharacteristic();

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', error);
                showError(`–û—à–∏–±–∫–∞: ${error.message}`);
                updateStatus('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'disconnected');
                updateButtons(false);
                device = null;
                server = null;
                service = null;
                characteristic = null;
            }
        }

        function onDisconnected(event) {
            console.log('–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ—Ç–∫–ª—é—á–µ–Ω–æ');
            updateStatus('–û—Ç–∫–ª—é—á–µ–Ω–æ', 'disconnected');
            updateButtons(false);
            device = null;
            server = null;
            service = null;
            characteristic = null;
        }

        function disconnect() {
            if (device && device.gatt.connected) {
                device.gatt.disconnect();
            }
            onDisconnected();
        }

        async function readCharacteristic() {
            try {
                if (!characteristic) {
                    throw new Error('–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                }

                updateStatus('–ß—Ç–µ–Ω–∏–µ...', 'scanning');
                const value = await characteristic.readValue();
                const decoder = new TextDecoder('utf-8');
                const text = decoder.decode(value);

                document.getElementById('readValue').textContent = text;
                document.getElementById('readValue').classList.remove('empty');

                updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ', 'connected');
                console.log('–ü—Ä–æ—á–∏—Ç–∞–Ω–æ:', text);

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è:', error);
                showError(`–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è: ${error.message}`);
                updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ', 'connected');
            }
        }

        async function writeCharacteristic() {
            try {
                if (!characteristic) {
                    throw new Error('–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                }

                const input = document.getElementById('writeValue');
                const text = input.value;

                if (!text) {
                    showError('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏');
                    return;
                }

                updateStatus('–û—Ç–ø—Ä–∞–≤–∫–∞...', 'scanning');
                const encoder = new TextEncoder();
                const value = encoder.encode(text);

                await characteristic.writeValue(value);

                updateStatus('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'connected');
                console.log('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ:', text);

                // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
                input.value = '';

                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–∏—Ç–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                setTimeout(() => {
                    readCharacteristic();
                }, 300);

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏:', error);
                showError(`–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏: ${error.message}`);
                updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ', 'connected');
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        document.getElementById('writeValue').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                writeCharacteristic();
            }
        });
    </script>
</body>
</html>
