<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Midi-Bayan">
    <title>Midi-Bayan Control</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.svg">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞: –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ midi-—Å–µ—Ä–≤–∏—Å—É -->
        <div id="screenEntrance" class="screen">
            <h1>üîµ XIAO-BLE Control</h1>
            <p class="subtitle">Web Bluetooth –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º</p>

            <div id="status" class="status disconnected">–û—Ç–∫–ª—é—á–µ–Ω–æ</div>
            <div id="error" class="error"></div>

            <div class="info">
                <strong>Service UUID:</strong> 12345678-1234-5678-1234-567890abcdef<br>
                <strong>Characteristic UUID:</strong> fedcba09-8765-4321-8765-432110325476
            </div>

            <button id="connectBtn" class="btn-primary" onclick="connect()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
            <button id="disconnectBtn" class="btn-danger" onclick="disconnect()" disabled>–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –Ω–∞—Å—Ç—Ä–æ–µ–∫: –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
        <div id="screenSettings" class="screen screen-hidden">
            <h1>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
            <p class="subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º</p>

            <div id="statusSettings" class="status connected">–ü–æ–¥–∫–ª—é—á–µ–Ω–æ</div>

            <button id="disconnectBtnSettings" class="btn-danger" onclick="disconnect()">–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>

            <div class="input-group">
                <label>–ü—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:</label>
                <div id="readValue" class="value-display empty">–ó–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ</div>
                <button id="readBtn" class="btn-success" onclick="readCharacteristic()">–ü—Ä–æ—á–∏—Ç–∞—Ç—å</button>
            </div>

            <div class="input-group">
                <label>–ù–æ–º–µ—Ä –∫–∞–Ω–∞–ª–∞ (0‚Äì15):</label>
                <input type="number" id="channelValue" min="0" max="15" value="0" />
                <button id="getProgramBtn" class="btn-secondary" onclick="sendGetProgram()">–ó–∞–ø—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É</button>
            </div>
        </div>
    </div>

    <script>
        const SERVICE_UUID = '12345678-1234-5678-1234-567890abcdef';
        const CHARACTERISTIC_UUID = 'fedcba09-8765-4321-8765-432110325476';

        let device = null;
        let server = null;
        let service = null;
        let characteristic = null;

        function updateStatus(text, className) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = text;
            statusEl.className = `status ${className}`;
            const statusSettings = document.getElementById('statusSettings');
            if (statusSettings && !document.getElementById('screenSettings').classList.contains('screen-hidden')) {
                statusSettings.textContent = text;
                statusSettings.className = `status ${className}`;
            }
        }

        function showError(message) {
            const errorEl = document.getElementById('error');
            errorEl.textContent = message;
            errorEl.classList.add('show');
            setTimeout(() => {
                errorEl.classList.remove('show');
            }, 5000);
        }

        const CMD_GET_PROGRAM = 0x01;

        function crc8(data) {
            let crc = 0;
            for (let i = 0; i < data.length; i++) {
                crc ^= data[i];
                for (let b = 0; b < 8; b++) {
                    if (crc & 0x80) {
                        crc = ((crc << 1) ^ 0x07) & 0xff;
                    } else {
                        crc = (crc << 1) & 0xff;
                    }
                }
            }
            return crc;
        }

        function buildGetProgramMessage(channel) {
            const payload = new Uint8Array([channel, 0, 0]);
            const payloadLen = payload.length;
            const msg = new Uint8Array(1 + 2 + payloadLen + 1);
            msg[0] = CMD_GET_PROGRAM;
            msg[1] = payloadLen & 0xff;
            msg[2] = (payloadLen >> 8) & 0xff;
            msg.set(payload, 3);
            msg[3 + payloadLen] = crc8(msg.subarray(0, 3 + payloadLen));
            return msg;
        }

        function switchScreens(connected) {
            const entrance = document.getElementById('screenEntrance');
            const settings = document.getElementById('screenSettings');
            if (connected) {
                entrance.classList.add('screen-hidden');
                settings.classList.remove('screen-hidden');
                document.getElementById('statusSettings').textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                document.getElementById('statusSettings').className = 'status connected';
            } else {
                entrance.classList.remove('screen-hidden');
                settings.classList.add('screen-hidden');
            }
        }

        function updateButtons(connected) {
            document.getElementById('connectBtn').disabled = connected;
            document.getElementById('disconnectBtn').disabled = !connected;
            switchScreens(connected);
        }

        async function connect() {
            try {
                updateStatus('–ü–æ–∏—Å–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞...', 'scanning');
                showError('');

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ Web Bluetooth
                if (!navigator.bluetooth) {
                    throw new Error('Web Bluetooth –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome/Edge –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ –∏–ª–∏ Android.');
                }

                // –ü–æ–∏—Å–∫ –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É
                device = await navigator.bluetooth.requestDevice({
                    filters: [{
                        services: [0x1234]
                        //name: 'Midi-Bayan'
                    }],
                    // acceptAllDevices: true,
                    optionalServices: [SERVICE_UUID]
                });

                updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...', 'scanning');

                device.addEventListener('gattserverdisconnected', onDisconnected);

                server = await device.gatt.connect();
                updateStatus('–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞...', 'scanning');

                service = await server.getPrimaryService(SERVICE_UUID);
                updateStatus('–ü–æ–ª—É—á–µ–Ω–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏...', 'scanning');

                characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);

                updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ', 'connected');
                updateButtons(true);

                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–∏—Ç–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
                await readCharacteristic();

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', error);
                showError(`–û—à–∏–±–∫–∞: ${error.message}`);
                updateStatus('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'disconnected');
                updateButtons(false);
                device = null;
                server = null;
                service = null;
                characteristic = null;
            }
        }

        function onDisconnected(event) {
            console.log('–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ—Ç–∫–ª—é—á–µ–Ω–æ');
            updateStatus('–û—Ç–∫–ª—é—á–µ–Ω–æ', 'disconnected');
            updateButtons(false);
            device = null;
            server = null;
            service = null;
            characteristic = null;
        }

        function disconnect() {
            if (device && device.gatt.connected) {
                device.gatt.disconnect();
            }
            onDisconnected();
        }

        async function readCharacteristic() {
            try {
                if (!characteristic) {
                    throw new Error('–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                }

                updateStatus('–ß—Ç–µ–Ω–∏–µ...', 'scanning');
                const value = await characteristic.readValue();
                const bytes = new Uint8Array(value.buffer, value.byteOffset, value.byteLength);
                const hex = Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join(' ');
                let text = hex;
                if (bytes.length === 3) {
                    text = `[${hex}]\n–ö–∞–Ω–∞–ª: ${bytes[0]}, –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: ${bytes[1]}, –û–∫—Ç–∞–≤–∞: ${bytes[2]}`;
                }

                document.getElementById('readValue').textContent = text;
                document.getElementById('readValue').classList.remove('empty');

                updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ', 'connected');
                console.log('–ü—Ä–æ—á–∏—Ç–∞–Ω–æ (–±–∞–π—Ç—ã):', hex);

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è:', error);
                showError(`–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è: ${error.message}`);
                updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ', 'connected');
            }
        }

        async function sendGetProgram() {
            try {
                if (!characteristic) {
                    throw new Error('–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                }
                const input = document.getElementById('channelValue');
                let channel = parseInt(input.value, 10);
                if (isNaN(channel) || channel < 0 || channel > 15) {
                    showError('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–∞–Ω–∞–ª–∞ –æ—Ç 0 –¥–æ 15');
                    return;
                }
                channel = channel & 0xff;
                updateStatus('–û—Ç–ø—Ä–∞–≤–∫–∞ get_program...', 'scanning');
                const msg = buildGetProgramMessage(channel);
                await characteristic.writeValue(msg);
                updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ', 'connected');
                console.log('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ get_program, channel:', channel);
                setTimeout(() => readCharacteristic(), 300);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ get_program:', error);
                showError(`–û—à–∏–±–∫–∞: ${error.message}`);
                updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ', 'connected');
            }
        }

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(() => {});
        }
    </script>
</body>
</html>
