<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Midi-Bayan">
    <title>Midi-Bayan Control</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.svg">
    <link rel="stylesheet" href="styles.css">
    <script src="api.js"></script>
</head>
<body>
    <div class="container">
        <!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞: –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ midi-—Å–µ—Ä–≤–∏—Å—É -->
        <div id="screenEntrance" class="screen">
            <h1>üîµ Midi-Bayan</h1>
            <p class="subtitle">Web Bluetooth –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º</p>

            <div id="status" class="status disconnected">–û—Ç–∫–ª—é—á–µ–Ω–æ</div>
            <div id="error" class="error"></div>

            <img src="bayan.jpg" alt="–ë–∞—è–Ω" class="bayan-image" />

            <button id="connectBtn" class="btn-primary" onclick="connect()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
            <button id="disconnectBtn" class="btn-danger" onclick="disconnect()" disabled>–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –Ω–∞—Å—Ç—Ä–æ–µ–∫: –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
        <div id="screenSettings" class="screen screen-hidden">
            <h1>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
            <p class="subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º</p>

            <div id="statusSettings" class="status connected">–ü–æ–¥–∫–ª—é—á–µ–Ω–æ</div>

            <button id="disconnectBtnSettings" class="btn-danger" onclick="disconnect()">–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>

            <div class="input-group">
                <label>–ö–∞–Ω–∞–ª:</label>
                <div class="channel-buttons">
                    <button type="button" class="btn-channel active" data-channel="0" onclick="selectChannelAndGetProgram(0)">–ú–µ–ª–æ–¥–∏—è</button>
                    <button type="button" class="btn-channel" data-channel="1" onclick="selectChannelAndGetProgram(1)">–ê–∫–∫–æ—Ä–¥</button>
                    <button type="button" class="btn-channel" data-channel="2" onclick="selectChannelAndGetProgram(2)">–ë–∞—Å</button>
                </div>
                <input type="hidden" id="channelValue" value="0" />
            </div>

            <div class="row-fields">
                <div class="input-group">
                    <label>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</label>
                    <select id="instrumentValue"></select>
                </div>
                <div class="input-group">
                    <label>–ì—Ä–æ–º–∫–æ—Å—Ç—å <span id="volumeValueDisplay">100</span></label>
                    <input type="range" id="volumeValue" min="0" max="127" value="100" oninput="document.getElementById('volumeValueDisplay').textContent=this.value" />
                </div>
                <div class="input-group">
                    <label>–û–∫—Ç–∞–≤–∞</label>
                    <div class="octave-control">
                        <button type="button" class="btn-octave" onclick="changeOctave(-1)" aria-label="–û–∫—Ç–∞–≤–∞ –º–∏–Ω—É—Å">‚àí</button>
                        <span id="octaveValueDisplay">0</span>
                        <button type="button" class="btn-octave" onclick="changeOctave(1)" aria-label="–û–∫—Ç–∞–≤–∞ –ø–ª—é—Å">+</button>
                    </div>
                    <input type="hidden" id="octaveValue" value="0" />
                </div>
            </div>

            <button id="saveBtn" class="btn-primary" onclick="sendSetProgram()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>

    <script>
        const SERVICE_UUID = '12345678-1234-5678-1234-567890abcdef';
        const CHARACTERISTIC_UUID = 'fedcba09-8765-4321-8765-432110325476';

        let device = null;
        let server = null;
        let service = null;
        let characteristic = null;

        function updateStatus(text, className) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = text;
            statusEl.className = `status ${className}`;
            const statusSettings = document.getElementById('statusSettings');
            if (statusSettings && !document.getElementById('screenSettings').classList.contains('screen-hidden')) {
                statusSettings.textContent = text;
                statusSettings.className = `status ${className}`;
            }
        }

        function showError(message) {
            const errorEl = document.getElementById('error');
            errorEl.textContent = message;
            errorEl.classList.add('show');
            setTimeout(() => {
                errorEl.classList.remove('show');
            }, 5000);
        }

        const CMD_SET_PROGRAM = 0x02;

        // General MIDI Program names (0‚Äì127)
        const GM_INSTRUMENTS = [
            'Acoustic Grand Piano', 'Bright Acoustic Piano', 'Electric Grand Piano', 'Honky-tonk Piano',
            'Electric Piano 1', 'Electric Piano 2', 'Harpsichord', 'Clavinet',
            'Celesta', 'Glockenspiel', 'Music Box', 'Vibraphone', 'Marimba', 'Xylophone', 'Tubular Bells', 'Dulcimer',
            'Drawbar Organ', 'Percussive Organ', 'Rock Organ', 'Church Organ', 'Reed Organ', 'Accordion', 'Harmonica', 'Tango Accordion',
            'Acoustic Guitar (nylon)', 'Acoustic Guitar (steel)', 'Electric Guitar (jazz)', 'Electric Guitar (clean)',
            'Electric Guitar (muted)', 'Overdriven Guitar', 'Distortion Guitar', 'Guitar Harmonics',
            'Acoustic Bass', 'Electric Bass (finger)', 'Electric Bass (pick)', 'Fretless Bass', 'Slap Bass 1', 'Slap Bass 2', 'Synth Bass 1', 'Synth Bass 2',
            'Violin', 'Viola', 'Cello', 'Contrabass', 'Tremolo Strings', 'Pizzicato Strings', 'Orchestral Harp', 'Timpani',
            'String Ensemble 1', 'String Ensemble 2', 'Synth Strings 1', 'Synth Strings 2', 'Choir Aahs', 'Voice Oohs', 'Synth Choir', 'Orchestra Hit',
            'Trumpet', 'Trombone', 'Tuba', 'Muted Trumpet', 'French Horn', 'Brass Section', 'Synth Brass 1', 'Synth Brass 2',
            'Soprano Sax', 'Alto Sax', 'Tenor Sax', 'Baritone Sax', 'Oboe', 'English Horn', 'Bassoon', 'Clarinet',
            'Piccolo', 'Flute', 'Recorder', 'Pan Flute', 'Blown Bottle', 'Shakuhachi', 'Whistle', 'Ocarina',
            'Lead 1 (square)', 'Lead 2 (sawtooth)', 'Lead 3 (calliope)', 'Lead 4 (chiff)', 'Lead 5 (charang)', 'Lead 6 (voice)', 'Lead 7 (fifths)', 'Lead 8 (bass + lead)',
            'Pad 1 (new age)', 'Pad 2 (warm)', 'Pad 3 (polysynth)', 'Pad 4 (choir)', 'Pad 5 (bowed)', 'Pad 6 (metallic)', 'Pad 7 (halo)', 'Pad 8 (sweep)',
            'FX 1 (rain)', 'FX 2 (soundtrack)', 'FX 3 (crystal)', 'FX 4 (atmosphere)', 'FX 5 (brightness)', 'FX 6 (goblins)', 'FX 7 (echoes)', 'FX 8 (sci-fi)',
            'Sitar', 'Banjo', 'Shamisen', 'Koto', 'Kalimba', 'Bag pipe', 'Fiddle', 'Shanai',
            'Tinkle Bell', 'Agogo', 'Steel Drums', 'Woodblock', 'Taiko Drum', 'Melodic Tom', 'Synth Drum', 'Reverse Cymbal',
            'Guitar Fret Noise', 'Breath Noise', 'Seashore', 'Bird Tweet', 'Telephone Ring', 'Helicopter', 'Applause', 'Gunshot'
        ];

        function initInstrumentSelect() {
            const sel = document.getElementById('instrumentValue');
            GM_INSTRUMENTS.forEach((name, i) => {
                const opt = document.createElement('option');
                opt.value = i;
                opt.textContent = i + '. ' + name;
                sel.appendChild(opt);
            });
        }

        function changeOctave(delta) {
            const el = document.getElementById('octaveValue');
            let v = parseInt(el.value, 10) + delta;
            v = Math.max(-3, Math.min(3, v));
            el.value = v;
            document.getElementById('octaveValueDisplay').textContent = v;
        }

        function buildSetProgramMessage(channel, instrument, volume, octave) {
            const payload = new Uint8Array([channel, instrument, volume, octave]);
            const payloadLen = payload.length;
            const msg = new Uint8Array(1 + 2 + payloadLen + 1);
            msg[0] = CMD_SET_PROGRAM;
            msg[1] = payloadLen & 0xff;
            msg[2] = (payloadLen >> 8) & 0xff;
            msg.set(payload, 3);
            msg[3 + payloadLen] = crc8(msg.subarray(0, 3 + payloadLen));
            return msg;
        }

        function switchScreens(connected) {
            const entrance = document.getElementById('screenEntrance');
            const settings = document.getElementById('screenSettings');
            if (connected) {
                entrance.classList.add('screen-hidden');
                settings.classList.remove('screen-hidden');
                document.getElementById('statusSettings').textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                document.getElementById('statusSettings').className = 'status connected';
            } else {
                entrance.classList.remove('screen-hidden');
                settings.classList.add('screen-hidden');
            }
        }

        function updateButtons(connected) {
            document.getElementById('connectBtn').disabled = connected;
            document.getElementById('disconnectBtn').disabled = !connected;
            switchScreens(connected);
        }

        async function connect() {
            try {
                updateStatus('–ü–æ–∏—Å–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞...', 'scanning');
                showError('');

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ Web Bluetooth
                if (!navigator.bluetooth) {
                    throw new Error('Web Bluetooth –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome/Edge –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ –∏–ª–∏ Android.');
                }

                // –ü–æ–∏—Å–∫ –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É
                device = await navigator.bluetooth.requestDevice({
                    filters: [{
                        services: [0x1234]
                        //name: 'Midi-Bayan'
                    }],
                    // acceptAllDevices: true,
                    optionalServices: [SERVICE_UUID]
                });

                updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...', 'scanning');

                device.addEventListener('gattserverdisconnected', onDisconnected);

                server = await device.gatt.connect();
                updateStatus('–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞...', 'scanning');

                service = await server.getPrimaryService(SERVICE_UUID);
                updateStatus('–ü–æ–ª—É—á–µ–Ω–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏...', 'scanning');

                characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);

                characteristic.addEventListener('characteristicvaluechanged', (event) => {
                    processCharacteristicValue(event.target.value);
                });
                await characteristic.startNotifications();

                updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ', 'connected');
                updateButtons(true);

                // –ù–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
                await readCharacteristic();

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', error);
                showError(`–û—à–∏–±–∫–∞: ${error.message}`);
                updateStatus('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'disconnected');
                updateButtons(false);
                device = null;
                server = null;
                service = null;
                characteristic = null;
            }
        }

        function onDisconnected(event) {
            console.log('–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ—Ç–∫–ª—é—á–µ–Ω–æ');
            updateStatus('–û—Ç–∫–ª—é—á–µ–Ω–æ', 'disconnected');
            updateButtons(false);
            device = null;
            server = null;
            service = null;
            characteristic = null;
        }

        function disconnect() {
            if (device && device.gatt.connected) {
                device.gatt.disconnect();
            }
            onDisconnected();
        }

        function processCharacteristicValue(value) {
            const buf = value.buffer || value;
            const bytes = new Uint8Array(buf, value.byteOffset || 0, value.byteLength || buf.byteLength);
            const hex = Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join(' ');
            console.log('–ó–Ω–∞—á–µ–Ω–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:', hex, '| –±–∞–π—Ç—ã:', bytes[0], bytes[1], bytes[2], bytes[3]);
            if (bytes.length >= 4) {
                console.log('  –∫–∞–Ω–∞–ª:', bytes[0], '–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç:', bytes[1], '–≥—Ä–æ–º–∫–æ—Å—Ç—å:', bytes[2], '–æ–∫—Ç–∞–≤–∞:', bytes[3]);
                fillProgramFields(bytes[1], bytes[2], bytes[3]);
            }
            updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ', 'connected');
        }

        async function readCharacteristic() {
            try {
                if (!characteristic) {
                    throw new Error('–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                }
                updateStatus('–ß—Ç–µ–Ω–∏–µ...', 'scanning');
                const value = await characteristic.readValue();
                processCharacteristicValue(value);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è:', error);
                showError(`–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è: ${error.message}`);
                updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ', 'connected');
            }
        }

        function selectChannelAndGetProgram(channel) {
            document.getElementById('channelValue').value = channel;
            document.querySelectorAll('.btn-channel').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.channel, 10) === channel);
            });
            sendGetProgram();
        }

        async function sendGetProgram() {
            try {
                if (!characteristic) {
                    throw new Error('–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                }
                const channel = parseInt(document.getElementById('channelValue').value, 10) & 0xff;
                updateStatus('–û—Ç–ø—Ä–∞–≤–∫–∞ get_program...', 'scanning');
                const msg = buildGetProgramMessage(channel);
                await characteristic.writeValue(msg);
                updateStatus('–û—Ç–ø—Ä–∞–≤–∫–∞ get_program...', 'scanning');
                console.log('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ get_program, channel:', channel);
                // –û—Ç–≤–µ—Ç –ø—Ä–∏–¥—ë—Ç –ø–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—é (characteristicvaluechanged)
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ get_program:', error);
                showError(`–û—à–∏–±–∫–∞: ${error.message}`);
                updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ', 'connected');
            }
        }

        async function sendSetProgram() {
            try {
                if (!characteristic) {
                    throw new Error('–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                }
                const channel = parseInt(document.getElementById('channelValue').value, 10);
                const instrument = parseInt(document.getElementById('instrumentValue').value, 10);
                const volume = parseInt(document.getElementById('volumeValue').value, 10);
                const octave = parseInt(document.getElementById('octaveValue').value, 10);
                if (isNaN(channel) || channel < 0 || channel > 15) {
                    showError('–ù–æ–º–µ—Ä –∫–∞–Ω–∞–ª–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 0 –¥–æ 15');
                    return;
                }
                if (isNaN(instrument) || instrument < 0 || instrument > 127) {
                    showError('–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 0 –¥–æ 127');
                    return;
                }
                if (isNaN(volume) || volume < 0 || volume > 127) {
                    showError('–ì—Ä–æ–º–∫–æ—Å—Ç—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 0 –¥–æ 127');
                    return;
                }
                if (isNaN(octave) || octave < -3 || octave > 3) {
                    showError('–û–∫—Ç–∞–≤–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç -3 –¥–æ 3');
                    return;
                }
                updateStatus('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...', 'scanning');
                const msg = buildSetProgramMessage(channel & 0xff, instrument & 0xff, volume & 0xff, octave & 0xff);
                await characteristic.writeValue(msg);
                updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ', 'connected');
                console.log('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ set_program:', channel, instrument, volume, octave);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ set_program:', error);
                showError(`–û—à–∏–±–∫–∞: ${error.message}`);
                updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ', 'connected');
            }
        }

        initInstrumentSelect();

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(() => {});
        }
    </script>
</body>
</html>
